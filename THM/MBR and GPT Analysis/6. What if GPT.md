Previously, we studied how the boot process propagates with the MBR. In this task, we will explore what the boot process looks like when a modern GPT partitioning scheme is used in the disk instead of the MBR.

UEFI firmware with the GPT partitioning scheme replaced BIOS firmware with the MBR partitioning scheme. This replacement occurred due to some limitations in the BIOS and the MBR. The GPT supports up to 9 zettabytes of hard disks, unlike the MBR, which supports a maximum of 2 terabytes. The GPT also supports up to 128 partitions, unlike the MBR, which only supports 4. There are some other differences between both of the partitioning schemes.  

GPT is now a preferred partitioning scheme in most modern systems. It is compatible with systems that have UEFI firmware. Let's take a look at the structure of the GPT.

We previously saw that the MBR only occupies the disk's first sector (512 bytes). However, this is not the case with the GPT. The GPT has five components spread across multiple sectors of the disk. Let's start dissecting each component of the GPT.

**Note:** We have extracted the first two components of the GPT in hex format and saved them at `C:\Analysis\GPT`. You can use this file in HxD to examine the GPT in this task. It is to be noted that the GPT provided to you in the attached machine is different from the one presented in the screenshots.

![Structure of GPT.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1737110838398.svg)  

## Protective MBR

Ideally, if the disk is GPT partitioned, the system should have UEFI firmware to handle it.  However, some legacy systems still use BIOS firmware even though the disk is GPT partitioned. This can be a problem as the BIOS firmware is designed to work with the MBR and UEFI firmware is designed to work with the GPT. To solve this problem, the GPT has Protective MBR. The Protective MBR is in the disk's first sector, partitioned with the GPT. The purpose of the Protective MBR  is to signal the BIOS system that this disk is using the GPT, so please don't mess up with it thinking that it is the MBR.

The Protective MBR also has three components, just like the general MBR, but with a few differences. Below is a screenshot of the Protective MBR found in the GPT, with its three components highlighted with different colors.

!["Protective MBR" portion of the GPT.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1734943004432.png)  

The details of these components are given below:

1. **Bootloader Code:** This bootloader code is not the same as it is in the general MBR. This bootloader code does not perform any function during the boot process. It is just there to look like it's the same standard MBR bootloader. This would be all 00s in most scenarios; however, sometimes, this can contain some placeholder code for legacy compatibility.
2. **Partition Table:** This partition table contains only one partition (the first 16 bytes), and this partition has one job; to redirect the system to the EFI Partition (which we will discuss later). The screenshot of the protective MBR above shows that it only has one partition in the table, and the other partitions are labeled with 0s. In this single partition, there is only one important thing: the 4th byte. This byte is set to `EE`, indicating that this is a GPT-formatted disk. 

![Partition Table of the Protective MBR.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1732018952352.png)

3. **MBR Signature:** The MBR signature is the same as in the standard MBR. It is set to `55 AA` and marks the end of the Protective MBR.  

## Primary GPT Header

The GPT header starts right from the next byte (the start of sector 1) after the Protective MBR ends at `55 AA` (the end of sector 0). It acts as a blueprint of the partitions on the disk. All the bytes in the GPT header have a specific meaning. Below is a screenshot of the GPT header with these bytes highlighted with different colors. It has the whole 512 sector space but occupies the first 92 bytes of space, and after these 92 bytes, there would be all `00` bytes for padding purposes to complete the sector's total bytes. So, for the Primary GPT header, you only need to focus on the first 92 bytes, which can give you some meaningful information.

![Primary GPT Header of the GPT Disk.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1732091427207.png)  

The table below shows the position of these bytes and their field names.

|Bytes Position|Bytes Length|Bytes|Field Name|
|---|---|---|---|
|0-7|8|45 46 49 20 50 41 52 54|Signature|
|8-11|4|00 00 01 00|Revision|
|12-15|4|5C 00 00 00|Header Size|
|16-19|4|71 89 13 1C|CRC32 of Header|
|20-23|4|00 00 00 00|Reserved|
|24-31|8|01 00 00 00 00 00 00 00|Current LBA|
|32-39|8|AF 32 CF 1D 00 00 00 00|Backup LBA|
|40-47|8|22 00 00 00 00 00 00 00|First Usable LBA|
|48-55|8|8E 32 CF 1D 00 00 00 00|Last Usable LBA|
|56-71|16|1D F1 B0 D6 43 BE 37 4E B1 E6 38 66 EC B1 73 89|Disk GUID|
|72-79|8|02 00 00 00 00 00 00 00|Partition Entry Array LBA|
|80-83|4|80 00 00 00|Number of Partition Entries|
|84-87|4|80 00 00 00|Size of Each Partition Entry|
|88-91|4|41 0D C0 22|CRC32 of Partition Array|

Each of these 14 fields has a specific purpose and meaning. Below is an explanation of all these fields. Before starting with the explanation of these fields, it is important to note that some of the fields represent Logical Block Addresses (LBA). To calculate the exact address through these LBAs, you must follow the same steps we performed while locating the partition in the MBR task. These steps included reversing the bytes stored in a little-endian format, then converting them to decimals and searching them on the HxD tool to jump to the exact LBA location.

1. **Signature:** This field has a value `45 46 49 20 50 41 52 54` which recognizes it as a GPT header. This value is always at the start of the GPT header.
2. **Revision:** The revision number is of 4 bytes and it represents the version of the GPT. Most of the times it would be `00 00 01 00` which means the GPT version is 1.0.
3. **Header Size:** This field represents the size of the GPT header. It is typically `5C 00 00 00` in hex and if you convert it to decimal (after reversing the order of bytes as they are in little-endian), it is 92 bytes which is the length of the GPT header.
4. **CRC32 of Header:** This is the CRC32 checksum of the GPT header, which if changed, would indicate that either the GPT header is tampered or corrupted.
5. **Reserved:** These are reserved bytes. The purpose of having them is to utilize them for any future changes in the GPT header.
6. **Current LBA:** The Current Logical Block Address (LBA) indicates the location of the GPT header. We know that its location is in sector 1, and we can verify this by converting the 8 Current LBA bytes `01 00 00 00 00 00 00 00` into decimal.
7. **Backup LBA:** In the GPT partitioning scheme, we have a backup of the GPT header as well, which we will be studying later on in this task. This field indicates the LBA of the backup GPT header.
8. **First Usable LBA:** This LBA address indicates the first address from which the partition can start on the disk.
9. **Last Usable LBA:** This LBA address indicates the last address to which the partitions on the disk can be written. Any partitions cannot occupy the disk space after the last usable LBA.
10. **Disk GUID:** This field is of 16 bytes and it presents a Globally Unique Identifier of the disk. The purpose of this GUID is to distinguish the disk from any other disks present in the system. In the current GPT header that we are analyzing, these bytes are `1D F1 B0 D6 43 BE 37 4E B1 E6 38 66 EC B1 73 89`. We can convert them to the standard GUID format of the disk by just reformatting them as `1DF1B0D6-43BE-374E-B1E6-3866ECB17389`.
11. **Partition Entry Array LBA:** This LBA address indicates the start of the Partition Entry Array which we are going to discuss ahead as the 3rd component of the GPT.
12. **Number of Partition Entries:** This field indicates the number of partitions that are on the disk. The GPT supports 128 partitions, unlike the MBR, which supports 4 partitions only. The value of this field is `80 00 00 00` which if converted to decimal will be 128.
13. **Size of Each Partition Entry:** This field indicates the size occupied by each partition entry array. In this example, it set to `80 00 00 00` which is 128 in decimal. It is important to note that this is not the size of the partition itself. This is just the size of partition entry array that we would be discussing next.
14. **CRC32 of Partition Array:** This is the CRC32 checksum of the whole partition entry array, which if changed, would indicate that either the partition entry array is tampered or corrupted.

## Partition Entry Array

We saw that sector zero was occupied by the Protective MBR, and the GPT header occupied sector 1. Now, from sector 2, the Partition Entry Array starts, just like the partition table present in the MBR, with a few differences. There are a total of 128 partitions on a GPT disk, and this partition entry array contains information about all these partitions.  Below is the screenshot of the Partition Entry Array of a GPT disk. Each partition entry is represented by 128 bytes.  You can only see the 6 partition entries out of the total 128 partition entries of the GPT. This is because there are only six working partitions in this disk. These six partitions would be present in blocks (128 bytes each) in this partition entry array, and after these working partitions, all the remaining 122 partition entries would be marked with `00`.  

![Partition Entry Array of a GPT partitioned disk.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1732103336630.png)

Let's use the first partition of the above screenshot as a reference to analyze the meaning of all the hexadecimal digits present in it.

The screenshot below shows the first partition entry from the partition entry array of the GPT. All the bytes (or groups of bytes) have some specific meaning. We have highlighted the different byte groups with different colors. 

![One of the entries of the Partition Entry Array of a GPT partitioned disk.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1732104106344.png)

The table below shows the fields represented by these bytes. 

|Bytes Position|Bytes Length|Bytes|Field Name|
|---|---|---|---|
|0-15|16|28 73 2A C1 1F F8 D2 11 BA 4B 00 A0 C9 3E C9 3B|Partition Type GUID|
|16-31|16|9E 43 0D 72 EC 12 54 44 8F B2 EE 17 8D F3 CD 3B|Unique Partition GUID|
|32-39|8|00 08 00 00 00 00 00 00|Starting LBA|
|40-47|8|FF 27 03 00 00 00 00 00|Ending LBA|
|48-55|8|00 00 00 00 00 00 00 80|Attributes|
|56-127|72|45 00 46 00 49 00 20 00 73 00 79 00 73 ...|Partition Name|

Each of these six fields has a specific purpose. Below is an explanation of all these fields. 

1. **Partition Type GUID:** This is the GUID of the partition type. This GUID will indicate the partition type, i.e., EFI System Partition, Basic Data Partition, etc. The 16 bytes of our partition entry are stored in mixed endian (little-endian and big-endian) format. This means we would have to reverse specific bytes and keep the other ones the same. In this case, we would do the following:

1. Reverse the first 4 bytes from `28 73 2A C1` to `C1 2A 73 28`, as they are in little-endian format.
2. Reverse the next 2 bytes from `1F F8` to `F8 1F`, as they are in little-endian format.
3. Reverse the next 2 bytes from `D2 11` to `11 D2` as they are in little-endian format.
4. Keep the next 2 bytes `BA 4B` as it is, as they are in big-endian format.
5. Keep the last 6 bytes `00 A0 C9 3E C9 3B` as it is, as they are in big-endian format.

The resulting GUID from steps 1-5 will be `C12A7328-F81F-11D2-BA4B-00A0C93EC93B`. Whatever GUID you get from here, you can search it on the internet to get the partition type associated with that GUID. The GUID we calculated is used for EFI System Partition (ESP).

**EFI System Partition (ESP)** is stored as a partition on every GPT disk and it is a very critical component in the boot process. In the MBR, we saw that the bootloaders are located in the bootcode and the bootable partition. In contrast, in the GPT, the bootloader is comprised of multiple files with **.efi** extension, and they all are stored in this EFI System Partition (ESP). Once the bootloader is found from the EFI System Partition, it loads the **Operating System's kernel** from the bootable partition of the disk, and after that, the drivers, services, and filesystems are loaded into the memory. Then the user is given the control of OS interface.

1. **Unique Partition GUID:** Unique Partition GUID is used to distinguish partitions on a disk. It is a unique GUID that is given to all the partitions on the disk. To convert these hexadecimal bytes into the standard GUID format, you can follow the same steps as we did for the first field (Partition Type GUID), as this is also stored in the mixed endian format.
2. **Starting LBA:** The starting LBA address indicates the area from where this partition starts on the disk. 
3. **Ending LBA:** The ending LBA address indicates the area at which this partition is ending on the disk.
4. **Attributes:** This field contains some flags that indicates some features of the partition, for example, if it is bootable, hidden, or normal.
5. **Partition Name:** This is the last field of the partition entry, and its size is 72 bytes. It represents the name of the partition in string format and is UTF-16 encoded. If you decode these bytes using any online hex-to-string decoder, you will get the partition name of this partition.

## Backup GPT Header

One of the biggest reasons the GPT replaced the MBR is its redundancy. In case of the MBR, if your MBR gets corrupted or changed due to hardware issues or malicious attacks, you have a minimal chance of recovery. On the other hand, the GPT has backups of its components. The Backup GPT Header is located at the last sector of the disk, and it can be used for recovery in case the Primary GPT Header is corrupted. It contains the same information as the Primary GPT Header.

## Backup Partition Entry Array

There is also a backup copy of the partition entry array. It is stored at the end of the disk just before the backup GPT header. It contains the same information as the partition entry array. It acts as a fail-safe mechanism in case the original partition entry array is damaged.