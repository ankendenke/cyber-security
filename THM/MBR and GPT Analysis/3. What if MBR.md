
## Analyzing the MBR

In the previous task, we learned about the boot process, from when the computer powers on till the bootable device is located. In this task, we will assume that the bootable device found uses the MBR partitioning scheme. MBR has been used for decades and is now replaced by the GPT in modern systems. However, it is important to learn the MBR as it is still used in some systems.

The bootable device, which was located in the 3rd step of the boot process, would be in the form of a disk. A disk is divided into multiple sectors, each with a standard size of 512 bytes. The first sector of this disk would contain the MBR.  A disk's MBR can be viewed by taking the system's disk image and opening it in a hexadecimal editor.

We will be using the HxD tool, a hexadecimal editor available in the taskbar of the attached machine. Open the HxD tool, click the File button in the options tab, and select Open from the options. Now, you have to input the file's location to be opened. We have extracted the MBR portion from a disk image and saved it at `C:\Analysis\MBR`. You can select this file to examine the MBR for this task.

![Opening a disk image in HxD hexeditor.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1733912342396.png)

This will open it in hexadecimal format. It is to be noted that the MBR provided to you in the attached machine is different from the one presented in the screenshots.

![MBR opened in the HxD hexeditor.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1734104958079.png)  

The Master Boot Record (MBR) takes up 512 bytes of space at the very first sector of the disk. Now, we know that it starts from the very first sector. We can easily analyze the MBR code by starting from the first line, but how do we know where this MBR code ends? The answer to this question is straightforward. Every two digits coupled in hexadecimal represents 1 byte, and once the first 512 bytes of the disk completes, the MBR has been ended. So, in the hexadecimal editor we are using, 16 bytes are present in each row, meaning that the first 32 rows of the disk would be the whole MBR. Another way to spot the end is by looking at the MBR signature. The MBR signature is represented by `55 AA`, which marks the end of the MBR code. You can look for these hexadecimal digits to identify where the MBR ends.

The screenshot below shows the MBR portion (first 512 bytes) of a disk when opened into the hex editor. You can see that these are the first 32 rows (16 bytes for each row) and ending at 55 AA (MBR Signature). The first highlighted portion represents the bytes offset, the second represents the actual hexadecimal bytes, and the third represents the ASCII-converted text of the hexadecimal bytes. We would focus on the second portion, the hexadecimal bytes. In this task, we will analyze this whole MBR by decoding the meaning of these hexadecimal digits. 

  

![Components of the HxD editors.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731928542517.png)  

Before we start analyzing the bytes, it's important to understand that together, every two hexadecimal digits present a single byte. These 512 bytes of the MBR are further divided into three portions. The following screenshot highlights each of the three portions of the MBR with different colors.

![Components of MBR highlighted with different colours.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731917826750.png)  

The structure of the MBR can be seen below:

![Structure of MBR.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1737110716769.svg)  

Let's dissect each of the three portions of the MBR.

## Bootloader Code (Bytes 0-446)

The first component of the MBR is the Bootloader code. They cover 446 out of the total 512 bytes of the MBR, as shown in the screenshot below: 

![Bootloader Code component of the MBR.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731920146062.png)  

This Bootloader code contains the **Initial Bootloader**. The initial bootloader is the first thing that executes in the MBR. This initial bootloader code has a primary purpose of finding the bootable partition from the **partition table** present on the MBR. 

**Note:** To better understand the initial bootloader code, it can be disassembled into assembly language, which is beyond the scope of this task.

## Partitions Table (Bytes 446-509)

The second component of the MBR is the partition table, which comprises 64 bytes (Bytes 446-509). This table contains the details of all the partitions present on the disk. One of the partitions in the disk contains all the operating system files necessary for booting, known as a bootable partition. The initial bootloader that was started from the bootloader code of the MBR  finds the bootable partition from this partition table, and it loads the second bootloader from it. The second bootloader then loads the **Operating System's Kernel**. A partition table is used during this boot process. However, this partition table can also give us valuable information during forensics. Let's dive into the details of this partition table.

An MBR disk has a total of 4 partitions, and each partition is represented by 16 bytes in the partition table. In the screenshot below, four partitions (each with 16 bytes) are highlighted with different colors. 

![Partitions Table component of the MBR.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731920146057.png)

Now, for your understanding, we have also shown the partition details of the same disk through the disk management utility of the Windows OS. The same four partitions can be seen here:

![Partitions information in the Disk Management feature of Windows.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1733741844707.png)  

Unlike the bootloader code, the hexadecimal digits of these partitions themselves can tell you many things. Let's use the first partition from the partition table screenshot as a reference to analyze the meaning of all the hexadecimal digits.

The screenshot below shows the first partition from the partition table of the MBR. All the bytes have some specific meaning. Some bytes individually represent a field, while others are grouped together to form a field. We have highlighted all these different byte groups with different colors. 

![One of the partitions from the partitions table shown in hex.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731927561284.png)

The table below shows the fields represented by these bytes. 

|Bytes Position|Bytes Length|Bytes|Field Name|
|---|---|---|---|
|0|1|80|Boot Indicator|
|1-3|3|20 21 00|Starting CHS Address|
|4|1|07|Partition Type|
|5-7|3|FE FF FF|Ending CHS Address|
|8-11|4|00 08 00 00|Starting LBA Address|
|12-15|4|00 B0 23 03|Number of Sectors|

Each field tells you something about the partition. Below is an explanation of all these fields:

1. **Boot Indicator:** This byte tells you whether the partition is bootable or not. A bootable partition contains files necessary for the operating system to boot. This boot indicator can only have one of the two values: `80` or `00`. If it's `80`, it means that the partition is bootable; else, if it's `00`, it means that the partition is not bootable.  In Windows based systems, **C:** is the partition that is typically bootable. If visualized through the partition table, this partition would have the boot indicator set to 80.
2. **Starting CHS Address:** Cylinder Head Sector (CHS) is the 3 bytes that tell you where this partition is starting from on the disk. It will give you the starting physical address of the partition, such as the cylinder, head, and sector number. This field is not that important as we now have the simplified logical address of the partition in the form of the Starting LBA Address discussed ahead.
3. **Partition Type:** Every partition uses a filesystem such as NTFS, FAT32, etc. This byte indicates the filesystem of the partition. The partition we are taking as a reference has this byte as `07`, which means it is an NTFS partition. Every filesystem has its own unique byte. You can learn about the bytes used for other filesystems from [here](https://www.writeblocked.org/resources/MBR_GPT_cheatsheet.pdf).
4. **Ending CHS Address:** The last 3 bytes at the end of the CHS Address indicates the physical location where the partition ends on the disk. This field is also not that important, just like the stated CHS address, as we mostly use the logical address (LBA) instead of the physical address.
5. **Starting LBA Address:** Logical Block Addressing (LBA) is the logical address that indicates the start of the partition. We saw that the Starting CHS Address also gives us the starting address of the partition, but because CHS gives you the physical address of the partition, it becomes difficult for us to locate it. However, the Starting LBA Address gives you the logical address of the partition rather than the physical address. You can use it to easily find the start of the partition on the disk in a hexadecimal editor. By locating the partition on the disk, you can also carve data from a disk's hidden or deleted partitions. Based on the partition we are analyzing as a reference with `00 08 00 00` LBA, we will use this logical address to locate our partition later in this task.
6. **Number of Sectors:** These last 4 bytes of a partition tell you the number of sectors in the partition. We will calculate the sector's size by using this field ahead.

From the information above, the boot indicator and the partition type bytes are pretty straightforward and do not need any more explanation. The starting and ending CHS addresses are physical addresses and do not hold much importance. However, let's see how we can use the **Starting LBA Address** to locate a partition and the **Number of Sectors** to calculate the size of the partition.

Locating the Partition

The starting LBA address bytes of the partition we are using as a reference in this task is `00 80 00 00`. These bytes are stored in the little-endian format in which the Least Significant Byte (LSB) is first, and the Most Significant Byte (MSB) is last. So, we must first reverse these bytes. Reversing these bytes would make it `00 00 80 00`. 

The next step is to convert these into decimal format. You can either use an online tool for this or view the decimal converted value of these bytes within the HxD hex editor tool. Select the bytes for which you need the decimal value, and it will be displayed in the Int32 option of the Data Inspector pane on the right side.

![MBR with Starting LBA of first partition highlighted.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731950113978.png)

Now that we have the decimal value as `2048`, we have to multiply it by the size of the sector, which is 512 bytes. 

`2048 x 512 = 1,048,576`

`1,048,576` is the exact value where the partition is stored. The last step is to search for this value in the HxD tool to jump to the start of this partition. To search this value, first click the **Search** button and then click the **Go to** option.

![Go to" feature of HxD to jump to specific location.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731950875219.png)

Now, input the value in the prompt, select the decimal format (dec) and click the OK button.

![Are to input the offset where we want to jump.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731950875220.png)

This will take you to the start of this partition on the disk. This can help you in carrying out detailed forensics of a specific partition. You can also recover any hidden or deleted data from here that has not yet been overwritten. As the file provided to you in this task is just comprised of the MBR and not the whole disk, you would not be able to jump to the starting LBA of the partition, which is in a separate place from the MBR.

**Note:** Please remember this method of reversing the LBA address (little endian), converting it to decimal, multiplying it with the sector size (512 bytes), and finally searching it into the hex editor to jump to the exact location. You will encounter some other Logical Block Addresses (LBA) in the GPT structure.

Calculating the Size of Partition

The last four partition bytes represent the Number of Sectors field. As per our partition, these bytes are `00 B0 23 03` and if we reverse it as they are in little-endian, they become `03 23 B0 00`. The next step is to convert them to decimal. You can find the decimal value within the HxD tool by highlighting the bytes just as we did for the starting LBA address while locating the partition. The decimal value comes out to be `52,670,464`. Now, as we know, each sector's size is 512 bytes. We can multiply them to get the size of this partition in bytes.

`52,670,464 x 512 = 26,967,277,568 bytes`

## MBR Signature (Bytes 510-511)

The last part of the MBR is the MBR Signature. It is just two bytes, which is short, but if messed up, it can cause huge trouble. The screenshot below shows the whole MBR with the MBR signature highlighted at the very bottom.

![MBR with MBR Signature highlighted.](https://tryhackme-images.s3.amazonaws.com/user-uploads/6645aa8c024f7893371eb7ac/room-content/6645aa8c024f7893371eb7ac-1731920146058.png)  

These two bytes `55 AA` are also known as a **Magic Number** and they indicate that the MBR has been ended now. If these two bytes are changed to some value other than `55 AA`, the system cannot boot. These bytes often get corrupted due to bad sectors on the disk and sometimes can be intentionally changed by malware to interrupt the normal boot process.

To sum up the whole boot process of the MBR:

1. The initial bootloader starts from the bootloader code (the first component of the MBR).
2. It then finds the bootable partition from the partition table (the second component of the MBR).
3. Then it loads the second bootloader from this bootable partition.
4. Finally, with this, the OS kernel gets loaded, and after this process, the drivers, services, and filesystems are loaded into the memory, and the user is given control of the OS interface. This is a system's whole boot process using an MBR partitioned disk.

Answer the questions below