Auth logs or authentication logs are crucial for monitoring and analyzing user authentication events on a Linux system. These logs provide detailed records of login attempts, both successful and unsuccessful, and can be instrumental in identifying potential security incidents, unauthorized access attempts, and suspicious activities.

### Location and Structure

Auth logs are normally stored in the `/var/log/auth.log` file on most Linux distributions. This log file records all authentication-related events, such as SSH logins, sudo attempts, etc. Each record consists of a timestamp, the service generating the log, the relevant user, and a short description of the event.

### Analyzing Auth Logs

Auth logs can be analyzed using standard command-line tools like grep, awk, and tail. Understanding and interpreting these logs can help system administrators and security professionals detect and respond to unauthorized access attempts and other security incidents.

As already discussed, auth logs are present in the `/var/log` directory in a file named `auth.log`. The auth.log file is a standard text log file and can be viewed using any of the text file parsers present in Linux, like `cat`, `less`, `tail`, etc. For instance, to see the most recent entries in the auth log, we might use the tail utility:

`sudo tail /var/log/auth.log`

This command displays the last ten lines of the auth log, giving us a quick overview of recent authentication events. We will see an output similar to the following as a result of running this command.

Auth log  

```shell-session
ubuntu@tryhackme:~$ tail /var/log/auth.log
Jun 19 19:07:12 tryhackme sudo: pam_unix(sudo:session): session opened for user root by (uid=0)
Jun 19 19:07:12 tryhackme su: (to root) ubuntu on pts/0
Jun 19 19:07:12 tryhackme su: pam_unix(su:session): session opened for user root by (uid=0)
Jun 19 19:07:23 tryhackme su: pam_unix(su:session): session closed for user root
Jun 19 19:07:23 tryhackme sudo: pam_unix(sudo:session): session closed for user root
Jun 19 19:07:33 tryhackme sudo:   ubuntu : TTY=pts/0 ; PWD=/home/ubuntu ; USER=root ; COMMAND=/usr/bin/vim /etc/hosts
Jun 19 19:07:33 tryhackme sudo: pam_unix(sudo:session): session opened for user root by (uid=0)
Jun 19 19:07:39 tryhackme sudo: pam_unix(sudo:session): session closed for user root
Jun 19 19:07:48 tryhackme sudo:   ubuntu : TTY=pts/0 ; PWD=/home/ubuntu ; USER=root ; COMMAND=/usr/bin/tail /var/log/auth.log
Jun 19 19:07:48 tryhackme sudo: pam_unix(sudo:session): session opened for user root by (uid=0)
```

  

Logs are rolled over after a set size is reached, and only the latest logs are present in the auth.log file. In such cases, the historical logs are stored in archived formats in files such as auth.log.1, auth.log.2.gz and so on. To search among such historical logs, we can use auth.log* instead of auth.log to use grep or other text parsers for more accurate historical results.

### Filtering Auth Logs

Since auth logs can be parsed using any of the text parsing utilities in Linux, we can use simple text filtering techniques to filter the auth logs as well. Filtering auth logs can help narrow down specific events of interest, such as failed login attempts or sudo command executions. Let's go through some common scenarios and practice how to filter them:

### Failure or Success of Login Attempts

To find all failed login attempts, we can use `grep` to search for "failure":

`sudo grep -i "failure" /var/log/auth.log`

As is evident, this command returns all entries where a login attempt was unsuccessful, providing details about the user and the source of the attempt.

Similarly, to filter for sessions opened for a user, search for "session opened":

`sudo grep -i "session opened" /var/log/auth.log`

As an example, this is how the result for searching for failed logins will look like:

Failed logins  

```shell-session
ubuntu@tryhackme:~$ /var/log$ sudo grep -i "failure" /var/log/auth.log*
/var/log/auth.log.1:Jun  9 14:01:54 tryhackme polkit-agent-helper-1[51951]: pam_unix(polkit-1:auth): authentication failure; logname= uid=1000 euid=0 tty= ruser=ubuntu rhost=  user=ubuntu
/var/log/auth.log.1:Jun 10 10:54:26 tryhackme polkit-agent-helper-1[65186]: pam_unix(polkit-1:auth): authentication failure; logname= uid=1000 euid=0 tty= ruser=ubuntu rhost=  user=ubuntu
/var/log/auth.log.1:Jun 10 10:54:35 tryhackme polkit-agent-helper-1[65191]: pam_unix(polkit-1:auth): authentication failure; logname= uid=1000 euid=0 tty= ruser=ubuntu rhost=  user=ubuntu
/var/log/auth.log.1:Jun 11 19:33:33 tryhackme su: pam_unix(su-l:auth): authentication failure; logname= uid=33 euid=0 tty= ruser=www-data rhost=  user=root
/var/log/auth.log.1:Jun 11 19:34:01 tryhackme su: pam_unix(su-l:auth): authentication failure; logname= uid=33 euid=0 tty= ruser=www-data rhost=  user=root
```

  

To further tweak the results, we can change the logging levels to provide us with more or less information, as discussed previously in this room.

#### **Sudo Command Executions**

To track the use of the sudo command, we can again use `grep` to search for "sudo":

`sudo grep "sudo" /var/log/auth.log`

This filter shows when users invoked sudo, which commands were executed, and whether the attempts were successful or failed.

An example execution of the above search will look like the following:

Sudo usage  

```shell-session
ubuntu@tryhackme:~$ grep "sudo" /var/log/auth.log*
/var/log/auth.log.1:Jun 12 22:51:08 tryhackme sudo:   ubuntu : TTY=pts/0 ; PWD=/home/ubuntu ; USER=root ; COMMAND=/usr/bin/systemctl disable tests.timer
/var/log/auth.log.1:Jun 12 22:51:08 tryhackme sudo: pam_unix(sudo:session): session opened for user root by (uid=0)
/var/log/auth.log.1:Jun 12 22:51:09 tryhackme sudo: pam_unix(sudo:session): session closed for user root
/var/log/auth.log.1:Jun 12 22:51:18 tryhackme sudo:   ubuntu : TTY=pts/0 ; PWD=/home/ubuntu ; USER=root ; COMMAND=/usr/bin/systemctl daemon-reload
/var/log/auth.log.1:Jun 12 22:51:18 tryhackme sudo: pam_unix(sudo:session): session opened for user root by (uid=0)
/var/log/auth.log.1:Jun 12 22:51:18 tryhackme sudo: pam_unix(sudo:session): session closed for user root
/var/log/auth.log.1:Jun 12 22:51:29 tryhackme sudo:   ubuntu : TTY=pts/0 ; PWD=/home/ubuntu ; USER=root ; COMMAND=/usr/bin/journalctl -u tests.service -f
/var/log/auth.log.1:Jun 12 22:51:29 tryhackme sudo: pam_unix(sudo:session): session opened for user root by (uid=0)
/var/log/auth.log.1:Jun 12 22:51:39 tryhackme sudo: pam_unix(sudo:session): session closed for user root
/var/log/auth.log.1:Jun 19 18:36:05 tryhackme sudo:   ubuntu : TTY=unknown ; PWD=/home/ubuntu ; USER=root ; COMMAND=/usr/bin/python3 -m websockify 80 localhost:5901 -D
/var/log/auth.log.1:Jun 19 18:36:05 tryhackme sudo: pam_unix(sudo:session): session opened for user root by (uid=0)
/var/log/auth.log.1:Jun 19 18:36:06 tryhackme sudo:   ubuntu : TTY=unknown ; PWD=/home/ubuntu ; USER=root ; COMMAND=/usr/sbin/runuser -l ubuntu -c vncserver :1 -depth 24 -geometry 1900x1200
/var/log/auth.log.1:Jun 19 18:36:06 tryhackme sudo: pam_unix(sudo:session): session opened for user root by (uid=0)
```

  

As we can see, the results also show us the log file from which the logs have been sourced, the date, time, and the command that was run.

#### **Time-Based Filters**

Filtering by date and time can be particularly useful for more focused investigations. It allows us to isolate events within a specific timeframe, which can be particularly helpful when investigating an incident that occurred in a specific time period.

#### **Filter by Date and Time**

To filter auth logs by a specific date and time range, we can use awk:

`sudo awk '/2024-06-04 15:30:00/,/2024-06-05 15:29:59/' /var/log/auth.log`

This command displays log entries between June 4, 2024, 15:30:00 and June 5, 2024, 15:29:59.

#### **Relative Time Filtering**

To filter entries from the last few hours, we can use tail in combination with grep and date:

`sudo grep "$(date --date='2 hours ago' '+%b %e %H:')" /var/log/auth.log`

This command filters log entries from the past two hours. We are actually using the Linux `date` utility to identify the current date and time and then extract the time in the format of the abbreviated month (`%b`), day of the month (`%e`), and hour (`%H`). An example execution of this command will look as follows:

Logs from the last two hours

```shell-session
ubuntu@tryhackme:~$ grep "$(date --date='2 hours ago' '+%b %e %H:')" /var/log/auth.log*
/var/log/auth.log:Jun 19 18:36:06 tryhackme runuser: pam_unix(runuser-l:session): session opened for user ubuntu by (uid=0)
/var/log/auth.log:Jun 19 18:36:07 tryhackme sudo: pam_unix(sudo:session): session closed for user root
/var/log/auth.log:Jun 19 18:36:07 tryhackme CRON[811]: pam_unix(cron:session): session closed for user ubuntu
/var/log/auth.log:Jun 19 18:36:10 tryhackme runuser: pam_unix(runuser-l:session): session closed for user ubuntu
/var/log/auth.log:Jun 19 18:36:10 tryhackme sudo: pam_unix(sudo:session): session closed for user root
/var/log/auth.log:Jun 19 18:36:10 tryhackme CRON[812]: pam_unix(cron:session): session closed for user ubuntu
/var/log/auth.log:Jun 19 18:36:10 tryhackme sshd[1106]: Server listening on 0.0.0.0 port 22.
/var/log/auth.log:Jun 19 18:36:10 tryhackme sshd[1106]: Server listening on :: port 22.
/var/log/auth.log:Jun 19 18:36:13 tryhackme lightdm: pam_unix(lightdm-greeter:session): session opened for user lightdm by (uid=0)
/var/log/auth.log:Jun 19 18:36:13 tryhackme systemd-logind[612]: New session c1 of user lightdm.
/var/log/auth.log:Jun 19 18:36:13 tryhackme systemd: pam_unix(systemd-user:session): session opened for user lightdm by (uid=0)
/var/log/auth.log:Jun 19 18:36:13 tryhackme lightdm: gkr-pam: gnome-keyring-daemon started properly
/var/log/auth.log:Jun 19 18:36:14 tryhackme gnome-keyring-daemon[1339]: couldn't connect to control socket at: /home/ubuntu/.cache/xdg/keyring/control: Connection refused
```

  

Auth logs are necessary resources for monitoring user authentication events and identifying potential security breaches. By analysing these logs using tools like awk, grep, and tail, administrators can streamline the process of extracting meaningful information from them and ensure the security of their environment.