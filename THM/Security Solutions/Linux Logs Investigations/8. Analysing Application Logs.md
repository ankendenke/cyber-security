Application logs are essential for monitoring and troubleshooting Linux applications. These logs are often stored in the `/var/log` directory and contain information about the application, details about their execution, and provide useful information regarding errors. 

Application logs provide information about client requests and server responses for web servers like Apache2. For databases, application logs will include information about database queries and responses. In this task, we'll explore how to manage and analyse application logs using Apache2 as an example.

### Understanding Apache2 Logs

Apache2 is a commonly used web server. It produces two types of logs: access logs and error logs.

- **Access logs**: Record all requests made to the server, including client IP addresses, request methods, requested URLs, response statuses, and more. 
- **Error logs**: Capture error messages generated by the server, such as configuration errors, script errors, and server crashes. 

Logs for Apache2 are generally placed in the `/var/log/apache2` directory. Generally, the `/var/log/apache2` directory contains two files, `/var/log/apache2/access.log` and `/var/log/apache2/error.log`, each containing the respective logs.

Apache2 logs are typically configured in the main configuration file (`/etc/apache2/apache2.conf`) or in the virtual host configuration files (e.g., `/etc/apache2/sites-available/000-default.conf`).

### Viewing Apache2 Logs

Apache2 logs are stored in the `/var/log/apache2/` directory by default. To view and analyse these logs, we can use common command-line utilities such as `cat`, `less`, or `tail`.

We can view the access log by using the tail utility:

`tail -f /var/log/apache2/access.log*`

Here is what the access log looks like:

Apache2 access log

```shell-session
ubuntu@tryhackme:~$ tail -f /var/log/apache2/access.log*
10.11.86.7 - - [12/Jun/2024:15:59:15 +0000] "GET /favicon.ico HTTP/1.1" 404 493 "http://10.10.104.189:8080/cmd.php?ip=10.10.225.142&port=5000" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:126.0) Gecko/20100101 Firefox/126.0"
10.11.86.7 - - [12/Jun/2024:16:35:25 +0000] "GET /cmd.php?ip=10.10.225.142&port=5000 HTTP/1.1" 200 205 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:126.0) Gecko/20100101 Firefox/126.0"
10.11.86.7 - - [12/Jun/2024:16:35:15 +0000] "GET /cmd.php?ip=10.10.146.99&port=5000 HTTP/1.1" 200 205 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:126.0) Gecko/20100101 Firefox/126.0"
10.10.24.106 - - [12/Jun/2024:19:28:04 +0000] "GET / HTTP/1.1" 200 484 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.24.106 - - [12/Jun/2024:19:28:04 +0000] "GET /favicon.ico HTTP/1.1" 404 493 "http://10.10.104.189:8080/" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.24.106 - - [12/Jun/2024:19:28:28 +0000] "GET /?cmd.php?ip=10.10.24.106&port=5000 HTTP/1.1" 200 484 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.24.106 - - [12/Jun/2024:19:28:34 +0000] "GET /?cmd.php?ip=10.10.24.106&port=5000 HTTP/1.1" 200 484 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.24.106 - - [12/Jun/2024:19:28:40 +0000] "GET /cmd.php?ip=10.10.24.106&port=5000 HTTP/1.1" 200 205 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.110.234 - - [12/Jun/2024:22:05:14 +0000] "GET /cmd.php?ip=10.10.110.234&port=5000 HTTP/1.1" 200 205 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.110.234 - - [12/Jun/2024:22:05:14 +0000] "GET /favicon.ico HTTP/1.1" 404 493 "http://10.10.104.189:8080/cmd.php?ip=10.10.110.234&port=5000" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
```

  

As can be seen, the access log contains the source IP address, date, time, request information, response code, and the user agent.

We can also use the tail utility to view the error log:

`tail -f /var/log/apache2/error.log*`

Here is what the output will look like:

Apacheerror log

```shell-session
ubuntu@tryhackme:~$ tail -f /var/log/apache2/error.log*
[Wed Jun 12 00:00:27.334620 2024] [mpm_prefork:notice] [pid 65787] AH00163: Apache/2.4.41 (Ubuntu) configured -- resuming normal operations
[Wed Jun 12 00:00:27.334650 2024] [core:notice] [pid 65787] AH00094: Command line: '/usr/sbin/apache2'
[Wed Jun 12 16:35:33.419815 2024] [php7:warn] [pid 78542] [client 10.11.86.7:59153] PHP Warning:  fsockopen(): unable to connect to 10.10.146.99:5000 (No route to host) in /var/www/html/cmd.php on line 10
[Wed Jun 12 16:35:33.419915 2024] [php7:warn] [pid 78542] [client 10.11.86.7:59153] PHP Warning:  proc_open(): Descriptor item must be either an array or a File-Handle in /var/www/html/cmd.php on line 11
[Wed Jun 12 19:09:37.359208 2024] [mpm_prefork:notice] [pid 65787] AH00169: caught SIGTERM, shutting down
[Wed Jun 12 19:24:51.225795 2024] [mpm_prefork:notice] [pid 817] AH00163: Apache/2.4.41 (Ubuntu) configured -- resuming normal operations
[Wed Jun 12 19:24:51.227391 2024] [core:notice] [pid 817] AH00094: Command line: '/usr/sbin/apache2'
```

  

### Filtering and Analysing Logs

When responding to incidents or analysing logs for any other purpose, we often need to find relevant information. This might feel like finding a needle in a haystack unless we know how to filter information. Below, we will follow through with some examples of filtering information from the Apache logs.

#### Filtering Using the Grep Utility

We can use the grep utility to filter out results from a specific IP address with the following command:

`grep "10.10.24.106" /var/log/apache2/access.log*`

The result is shown in the below terminal window.

Logs from specific IP

```shell-session
ubuntu@tryhackme:~$ grep 10.10.24.106 /var/log/apache2/access.log*
10.10.24.106 - - [12/Jun/2024:19:28:04 +0000] "GET / HTTP/1.1" 200 484 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.24.106 - - [12/Jun/2024:19:28:04 +0000] "GET /favicon.ico HTTP/1.1" 404 493 "http://10.10.104.189:8080/" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.24.106 - - [12/Jun/2024:19:28:28 +0000] "GET /?cmd.php?ip=10.10.24.106&port=5000 HTTP/1.1" 200 484 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.24.106 - - [12/Jun/2024:19:28:34 +0000] "GET /?cmd.php?ip=10.10.24.106&port=5000 HTTP/1.1" 200 484 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.24.106 - - [12/Jun/2024:19:28:40 +0000] "GET /cmd.php?ip=10.10.24.106&port=5000 HTTP/1.1" 200 205 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
```

Similarly, we can use the grep utility to filter out HTTP status codes as well.

`grep "404" /var/log/apache2/access.log*`

The output will look something like this:

Logs for specific response code

```shell-session
ubuntu@tryhackme:~$ grep "404" /var/log/apache2/access.log* 
10.11.86.7 - - [12/Jun/2024:15:59:15 +0000] "GET /favicon.ico HTTP/1.1" 404 493 "http://10.10.104.189:8080/cmd.php?ip=10.10.225.142&port=5000" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:126.0) Gecko/20100101 Firefox/126.0"
10.10.24.106 - - [12/Jun/2024:19:28:04 +0000] "GET /favicon.ico HTTP/1.1" 404 493 "http://10.10.104.189:8080/" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
10.10.110.234 - - [12/Jun/2024:22:05:14 +0000] "GET /favicon.ico HTTP/1.1" 404 493 "http://10.10.104.189:8080/cmd.php?ip=10.10.110.234&port=5000" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/109.0"
```

The grep utility can also be used to find specific error codes in the error logs.

`grep "error" /var/log/apache2/error.log*`

#### Filtering Using the Awk Utility

Using the awk utility, we can do advanced filtering, such as counting the number of requests from a specific IP address. The following command can be used to perform this task.

`awk '{print $1}' /var/log/apache2/access.log* | sort | uniq -c | sort -nr`

The output will show us the number of requests each IP address made.

Requests per IP address

```shell-session
ubuntu@tryhackme:~$ awk '{print $1}' /var/log/apache2/access.log* | sort | uniq -c | sort -nr
      5 10.10.24.106
      4 10.11.86.7
      2 10.10.110.234
```

Similarly, we can use the following command to summarise the HTTP status codes from the access logs.

`awk '{print $9}' /var/log/apache2/access.log* | sort | uniq -c | sort -nr`

The output will contain the number of times each HTTP status code was returned by the server.

Status codes summary

```shell-session
ubuntu@tryhackme:~$ awk '{print $9}' /var/log/apache2/access.log* | sort | uniq -c | sort -nr
      8 200
      3 404
```

Similarly, other types of application logs may also be leveraged to provide useful information in a Linux system. Application logs are essential when performing incident response as public-facing applications often prove to be the entry points for attackers. Therefore, application logs can provide us with crucial information related to initial access gained by a threat actor.